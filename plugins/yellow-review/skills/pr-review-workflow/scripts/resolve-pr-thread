#!/bin/sh
# Resolve a single PR review thread via GitHub GraphQL API.
# Usage: resolve-pr-thread <thread-node-id>
# Output: JSON to stdout: {"resolved": true, "threadId": "PRRT_..."}
# Errors: Exit 1 with message to stderr.

set -eu

# --- Dependency checks ---
command -v gh >/dev/null 2>&1 || { printf 'Error: gh CLI not found. Install from https://cli.github.com\n' >&2; exit 1; }
command -v jq >/dev/null 2>&1 || { printf 'Error: jq not found. Install from https://jqlang.github.io/jq\n' >&2; exit 1; }

# --- Input validation ---
if [ $# -lt 1 ]; then
    printf 'Usage: resolve-pr-thread <thread-node-id>\n' >&2
    exit 1
fi

THREAD_ID="$1"

# Validate thread ID format (must start with PRRT_)
case "$THREAD_ID" in
    PRRT_*)
        # Valid prefix
        ;;
    *)
        printf 'Error: Invalid thread ID format. Expected PRRT_ prefix, got: %s\n' "$THREAD_ID" >&2
        exit 1
        ;;
esac

# --- GraphQL mutation ---
# shellcheck disable=SC2016
MUTATION='
mutation($threadId: ID!) {
  resolveReviewThread(input: { threadId: $threadId }) {
    thread {
      id
      isResolved
    }
  }
}'

# --- Execute mutation ---
_STDERR_FILE=$(mktemp)
RESPONSE=$(gh api graphql \
    -F threadId="$THREAD_ID" \
    -f query="$MUTATION" 2>"$_STDERR_FILE")
_GH_EXIT=$?
_GH_STDERR=$(cat "$_STDERR_FILE"); rm -f "$_STDERR_FILE"
if [ "$_GH_EXIT" -ne 0 ]; then
    case "$_GH_STDERR" in
        *"401"*|*"Bad credentials"*|*"authentication"*)
            printf 'Error: Authentication failed. Run "gh auth login" to re-authenticate.\n' >&2
            ;;
        *"Could not resolve"*|*"not found"*|*"NOT_FOUND"*)
            printf 'Error: Thread not found: %s\n' "$THREAD_ID" >&2
            ;;
        *"rate limit"*|*"429"*)
            printf 'Error: GitHub API rate limit exceeded. Wait and retry.\n' >&2
            ;;
        *"already resolved"*|*"ALREADY_RESOLVED"*)
            # Idempotent â€” treat as success
            jq -n --arg id "$THREAD_ID" '{"resolved": true, "threadId": $id}'
            exit 0
            ;;
        *)
            printf 'Error: GraphQL mutation failed: %s\n' "$_GH_STDERR" >&2
            ;;
    esac
    exit 1
fi

# --- Validate response ---
IS_RESOLVED=$(printf '%s' "$RESPONSE" | jq -r '.data.resolveReviewThread.thread.isResolved // empty') || {
    printf '[resolve-pr-thread] Error: Failed to parse mutation response.\n' >&2
    exit 1
}

if [ "$IS_RESOLVED" = "true" ]; then
    jq -n --arg id "$THREAD_ID" '{"resolved": true, "threadId": $id}'
else
    # Check for GraphQL-level errors
    ERRORS=$(printf '%s' "$RESPONSE" | jq -r '.errors[0].message // empty') || {
        printf '[resolve-pr-thread] Error: Failed to parse GraphQL error response.\n' >&2
        exit 1
    }
    if [ -n "$ERRORS" ]; then
        # Check for already-resolved in error message (idempotent)
        case "$ERRORS" in
            *"already resolved"*)
                jq -n --arg id "$THREAD_ID" '{"resolved": true, "threadId": $id}'
                exit 0
                ;;
        esac
        printf 'Error: %s\n' "$ERRORS" >&2
    else
        printf 'Error: Thread resolution returned unexpected state.\n' >&2
    fi
    exit 1
fi
