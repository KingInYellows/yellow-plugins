name: Validate Marketplace and CI Suite

on:
  pull_request:
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**/.claude-plugin/plugin.json'
      - 'schemas/*.schema.json'
      - 'scripts/validate-*.js'
      - 'api/cli-contracts/*.json'
      - 'packages/**/*.ts'
      - '.github/workflows/validate-schemas.yml'
  push:
    branches:
      - main
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**/.claude-plugin/plugin.json'
      - 'schemas/*.schema.json'
      - 'api/cli-contracts/*.json'
  workflow_dispatch:

# Cancel stale workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  # ============================================================================
  # CRITICAL PATH JOB: Schema Validation (must complete in < 60s per SLO)
  # ============================================================================
  validate-schemas:
    name: Validate Schemas (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 2  # NFR-MAINT-002: Critical path budget

    strategy:
      fail-fast: false
      matrix:
        target:
          - marketplace
          - plugins
          - contracts
          - examples

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Install AJV CLI
        run: npm install -g ajv-cli@5.0.0

      - name: Start schema validation timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run schema validations
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/validate-${{ matrix.target }}.log"
          : > "$LOG_PATH"

          {
            case "${{ matrix.target }}" in
              marketplace)
                echo "::group::Schema validation"
                ajv validate \
                  -s schemas/marketplace.schema.json \
                  -d .claude-plugin/marketplace.json \
                  --strict=true \
                  --all-errors
                echo "::endgroup::"

                echo "::group::Business rules validation"
                node scripts/validate-marketplace.js
                echo "::endgroup::"
                ;;
              plugins)
                echo "::group::Finding plugin manifests"
                PLUGIN_MANIFESTS=$(find plugins -type f -name 'plugin.json' -path '*/.claude-plugin/plugin.json' || true)

                if [ -z "$PLUGIN_MANIFESTS" ]; then
                  echo "::warning::No plugin.json files found"
                  exit 0
                fi

                echo "Found manifests:"
                echo "$PLUGIN_MANIFESTS"
                echo "::endgroup::"

                echo "::group::Schema validation"
                for manifest in $PLUGIN_MANIFESTS; do
                  echo "Validating: $manifest"
                  ajv validate \
                    -s schemas/plugin.schema.json \
                    -d "$manifest" \
                    --strict=true \
                    --all-errors
                done
                echo "::endgroup::"

                echo "::group::Plugin-specific validation"
                for manifest in $PLUGIN_MANIFESTS; do
                  node scripts/validate-plugin.js --plugin "$manifest"
                done
                echo "::endgroup::"
                ;;
              contracts)
                echo "::group::Contract schema validation"
                CONTRACTS=$(find api/cli-contracts -name '*.json' -type f || true)

                if [ -z "$CONTRACTS" ]; then
                  echo "::warning::No contract files found"
                  exit 0
                fi

                echo "Found contracts:"
                echo "$CONTRACTS"

                for contract in $CONTRACTS; do
                  echo "Validating JSON syntax: $contract"
                  node -e "JSON.parse(require('fs').readFileSync('$contract', 'utf8'))"
                done
                echo "::endgroup::"
                ;;
              examples)
                echo "::group::Marketplace examples"
                if [ -f examples/marketplace.example.json ]; then
                  ajv validate \
                    -s schemas/marketplace.schema.json \
                    -d examples/marketplace.example.json \
                    --strict=true \
                    --all-errors
                fi
                echo "::endgroup::"

                echo "::group::Plugin examples"
                find examples -name 'plugin*.json' -type f | while read example; do
                  echo "Validating: $example"
                  ajv validate \
                    -s schemas/plugin.schema.json \
                    -d "$example" \
                    --strict=true \
                    --all-errors
                done
                echo "::endgroup::"
                ;;
              *)
                echo "::error::Unknown validation target: ${{ matrix.target }}"
                exit 1
                ;;
            esac
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture schema validation duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine validation status
        if: always()
        id: validation-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export validation metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh schema_validation "${{ steps.validation-status.outputs.status }}" target="${{ matrix.target }}" > ".ci-metrics/validate-${{ matrix.target }}.prom"

      - name: Upload validation metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-validate-${{ matrix.target }}
          path: .ci-metrics/validate-${{ matrix.target }}.prom
          retention-days: 7

      - name: Upload validation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-validate-${{ matrix.target }}
          path: .ci-logs/validate-${{ matrix.target }}.log
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # LINT & TYPECHECK JOB
  # ============================================================================
  lint-and-typecheck:
    name: Lint & TypeCheck
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start lint and typecheck timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run lint and typecheck
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/lint-typecheck.log"
          : > "$LOG_PATH"
          {
            echo "::group::Linting TypeScript sources"
            pnpm lint
            echo "::endgroup::"

            echo "::group::Type checking"
            pnpm typecheck
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture lint duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine lint status
        if: always()
        id: lint-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export lint metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh lint "${{ steps.lint-status.outputs.status }}" > .ci-metrics/lint-typecheck.prom

      - name: Upload lint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-lint
          path: |
            .ci-metrics/lint-typecheck.prom
            .ci-logs/lint-typecheck.log
          retention-days: 7

  # ============================================================================
  # UNIT TESTS JOB
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint-and-typecheck]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start unit test timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run unit tests
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/unit-tests.log"
          : > "$LOG_PATH"
          {
            echo "::group::Unit test execution"
            pnpm test:unit --reporter=verbose
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture unit test duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine unit test status
        if: always()
        id: unit-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export unit test metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh unit_test "${{ steps.unit-status.outputs.status }}" > .ci-metrics/unit-tests.prom

      - name: Upload unit test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-unit-tests
          path: |
            .ci-metrics/unit-tests.prom
            .ci-logs/unit-tests.log
          retention-days: 7

  # ============================================================================
  # INTEGRATION TESTS JOB
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [unit-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start integration test timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/integration-tests.log"
          : > "$LOG_PATH"
          {
            echo "::group::Integration test execution"
            pnpm test:integration --reporter=verbose
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture integration test duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine integration test status
        if: always()
        id: integration-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export integration test metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh integration_test "${{ steps.integration-status.outputs.status }}" > .ci-metrics/integration-tests.prom

      - name: Upload integration test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-integration-tests
          path: |
            .ci-metrics/integration-tests.prom
            .ci-logs/integration-tests.log
          retention-days: 7

  # ============================================================================
  # CONTRACT DRIFT DETECTION
  # ============================================================================
  contract-drift:
    name: Contract Drift Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [validate-schemas]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for drift detection

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install AJV CLI
        run: npm install -g ajv-cli@5.0.0

      - name: Start contract drift timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run contract drift checks
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/contract-drift.log"
          : > "$LOG_PATH"
          {
            echo "::group::Detecting contract changes"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              CHANGED=$(git diff --name-only origin/main...HEAD | grep -E '^api/cli-contracts/.*\.json$' || true)
              if [ -z "$CHANGED" ]; then
                echo "No contract changes detected"
              else
                echo "Contract files changed:"
                echo "$CHANGED"
                echo "::warning::CLI contracts have been modified. Ensure backward compatibility!"
              fi
            else
              echo "Contract drift diff only runs on pull_request events (current: ${{ github.event_name }})"
            fi
            echo "::endgroup::"

            echo "::group::Validating CLI contract schemas"
            CONTRACTS=$(find api/cli-contracts -name '*.json' -type f || true)
            if [ -z "$CONTRACTS" ]; then
              echo "::warning::No contract schemas found under api/cli-contracts"
            else
              for contract in $CONTRACTS; do
                echo "Validating JSON syntax: $contract"
                node -e "JSON.parse(require('fs').readFileSync('$contract', 'utf8'))"
              done
            fi
            echo "::endgroup::"

            echo "::group::Validating contract examples"
            if compgen -G "examples/requests/*.json" > /dev/null || compgen -G "examples/responses/*.json" > /dev/null; then
              for contract in $CONTRACTS; do
                base=$(basename "$contract" .json)

                if compgen -G "examples/requests/${base}*.json" > /dev/null; then
                  for request in examples/requests/${base}*.json; do
                    [ -e "$request" ] || continue
                    echo "Validating request example $request with $contract"
                    ajv validate -s "$contract" -d "$request"
                  done
                fi

                if compgen -G "examples/responses/${base}*.json" > /dev/null; then
                  for response in examples/responses/${base}*.json; do
                    [ -e "$response" ] || continue
                    echo "Validating response example $response with $contract"
                    ajv validate -s "$contract" -d "$response"
                  done
                fi
              done
            else
              echo "No contract example files found in examples/requests or examples/responses"
            fi
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture contract drift duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine contract drift status
        if: always()
        id: contract-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export contract drift metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh contract_drift "${{ steps.contract-status.outputs.status }}" > .ci-metrics/contract-drift.prom

      - name: Upload contract drift artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-contract-drift
          path: |
            .ci-metrics/contract-drift.prom
            .ci-logs/contract-drift.log
          retention-days: 7

  # ============================================================================
  # SECURITY AUDIT
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start security audit timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run security audit
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/security-audit.log"
          : > "$LOG_PATH"
          {
            echo "::group::Dependency security audit"
            pnpm audit --audit-level moderate || echo "::warning::Vulnerabilities detected"
            echo "::endgroup::"

            echo "::group::Scanning for secrets in manifests"
            SENSITIVE=$(grep -rE '(api[_-]?key|password|token|secret)' .claude-plugin/ plugins/ --include="*.json" | grep -v '"permissionScopes"' || true)
            if [ -n "$SENSITIVE" ]; then
              echo "$SENSITIVE"
              echo "::error::Potential sensitive data found in manifest files"
              exit 1
            else
              echo "No sensitive data patterns detected"
            fi
            echo "::endgroup::"

            echo "::group::Permission scope validation"
            if [ -f scripts/validate-permissions.js ]; then
              node scripts/validate-permissions.js || echo "::warning::Permission validation script returned non-zero exit code"
            else
              echo "::notice::Permission validation script not present; skipping"
            fi
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture security audit duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine security audit status
        if: always()
        id: security-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export security audit metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh security_audit "${{ steps.security-status.outputs.status }}" > .ci-metrics/security-audit.prom

      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-security-audit
          path: |
            .ci-metrics/security-audit.prom
            .ci-logs/security-audit.log
          retention-days: 7

  # ============================================================================
  # BUILD VERIFICATION (Optional, runs on main branch only)
  # ============================================================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.ref == 'refs/heads/main'
    needs: [validate-schemas, lint-and-typecheck, unit-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start build timer
        run: echo "CI_JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: Build all packages
        run: |
          set -euo pipefail
          mkdir -p .ci-logs
          LOG_PATH=".ci-logs/build.log"
          : > "$LOG_PATH"
          {
            echo "::group::Building workspace packages"
            pnpm build
            echo "::endgroup::"
          } 2>&1 | tee -a "$LOG_PATH"

      - name: Capture build duration
        if: always()
        run: echo "CI_STAGE_DURATION=$(( $(date +%s) - CI_JOB_START ))" >> $GITHUB_ENV

      - name: Determine build status
        if: always()
        id: build-status
        run: |
          if ${{ success() }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif ${{ failure() }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

      - name: Export build metrics
        if: always()
        run: |
          mkdir -p .ci-metrics
          ./scripts/export-ci-metrics.sh build "${{ steps.build-status.outputs.status }}" > .ci-metrics/build.prom

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-build
          path: |
            .ci-metrics/build.prom
            .ci-logs/build.log
          retention-days: 7

  # ============================================================================
  # AGGREGATE METRICS AND REPORT
  # ============================================================================
  report-metrics:
    name: Aggregate CI Metrics
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-schemas, lint-and-typecheck, unit-tests, integration-tests, contract-drift, security-audit, build]

    steps:
      - name: Download all metrics artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: metrics-*
          path: all-metrics/
          merge-multiple: true
          if-no-files-found: ignore

      - name: Aggregate metrics
        run: |
          echo "::group::Aggregating Prometheus metrics"
          mkdir -p aggregated-metrics all-metrics
          if ! find all-metrics -name '*.prom' -print -quit | grep -q .; then
            echo "::warning::No metrics artifacts found"
            : > aggregated-metrics/ci-metrics.prom
          else
            find all-metrics -name '*.prom' -exec cat {} + > aggregated-metrics/ci-metrics.prom
          fi
          echo "::endgroup::"

          echo "::group::Metrics summary"
          cat aggregated-metrics/ci-metrics.prom
          echo "::endgroup::"

      - name: Upload aggregated metrics
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics-aggregated
          path: aggregated-metrics/ci-metrics.prom
          retention-days: 30

      - name: Check SLO compliance
        run: |
          echo "::group::SLO Compliance Check"
          echo "Target: Schema validation jobs < 60 seconds"
          python <<'PY'
import sys, pathlib
path = pathlib.Path("aggregated-metrics/ci-metrics.prom")
if not path.exists():
    print("::warning::Aggregated metrics file missing")
    sys.exit(0)
violations = []
for line in path.read_text().splitlines():
    if not line.startswith("yellow_plugins_ci_duration_seconds{"):
        continue
    labels_raw, value_raw = line[len("yellow_plugins_ci_duration_seconds{"):].split("} ")
    labels = {}
    for pair in labels_raw.split(","):
        if "=" not in pair:
            continue
        key, val = pair.split("=", 1)
        labels[key] = val.strip('"')
    try:
        value = float(value_raw.strip())
    except ValueError:
        continue
    if labels.get("stage") == "schema_validation" and value > 60:
        violations.append((labels.get("target", "unknown"), value))

if violations:
    for target, duration in violations:
        print(f"::error::Schema validation target '{target}' exceeded 60s budget ({duration:.2f}s)")
    sys.exit(1)

print("All schema validation metrics within 60s budget.")
PY
          echo "::endgroup::"

  # ============================================================================
  # FINAL STATUS CHECK
  # ============================================================================
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-schemas, lint-and-typecheck, unit-tests, integration-tests, contract-drift, security-audit, build]

    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate-schemas.result }}" == "success" ] && \
             [ "${{ needs.lint-and-typecheck.result }}" == "success" ] && \
             [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ] && \
             [ "${{ needs.contract-drift.result }}" == "success" ] && \
             [ "${{ needs.security-audit.result }}" == "success" ] && \
             { [ "${{ needs.build.result }}" == "success" ] || [ "${{ needs.build.result }}" == "skipped" ]; }; then
            echo "::notice::✅ All CI validation checks passed"
            exit 0
          else
            echo "::error::❌ One or more CI checks failed"
            echo "Schema Validation: ${{ needs.validate-schemas.result }}"
            echo "Lint & TypeCheck: ${{ needs.lint-and-typecheck.result }}"
            echo "Unit Tests: ${{ needs.unit-tests.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"
            echo "Contract Drift: ${{ needs.contract-drift.result }}"
            echo "Security Audit: ${{ needs.security-audit.result }}"
            echo "Build (main only): ${{ needs.build.result }}"
            exit 1
          fi
