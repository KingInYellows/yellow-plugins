@startuml install-sequence
' Install/Update/Rollback Transaction Sequence Diagram
' Claude Code Plugin Marketplace - Install Transaction Orchestrator
'
' This diagram documents the install/update/rollback flow per Section 2.1
' and the 7-step transaction lifecycle from Architecture §3.10
'
' Generated for: Task I2.T3 - Install Transaction Orchestrator
' Date: 2026-01-11
' Spec References: FR-001, FR-003, CRIT-001, CRIT-002, CRIT-004, CRIT-010, CRIT-018

!theme plain
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam SequenceMessageAlign center

actor User
participant "CLI\nInstall Handler" as CLI
participant "Install\nTransaction\nOrchestrator" as Orchestrator
participant "Cache\nManager" as Cache
participant "Registry\nService" as Registry
participant "Compatibility\nEngine" as Compat
participant "Plugin Metadata\nValidator" as Validator
participant "Lifecycle\nSandbox" as Lifecycle
participant "Symlink\nActivator" as Symlink
participant "Telemetry\nLogger" as Telemetry
database "Cache\nArtifacts" as CacheDB
database "Registry\nJSON" as RegistryDB

== Install Transaction Lifecycle (Architecture §3.10) ==

User -> CLI: plugin install <id> [--version <ver>]
note right: **FR-001: Install Plugin**\nCRIT-001: Transaction tracking

CLI -> CLI: Generate transactionId\n(tx-<timestamp>-<uuid>)
CLI -> CLI: Build InstallRequest\n(compatibility intent, rollback plan)

CLI -> Orchestrator: install(request)
note right: **Step 1: VALIDATE**\nMarketplace freshness\nCompatibility check

Orchestrator -> Registry: getPlugin(pluginId)
Registry --> Orchestrator: existingPlugin | undefined

alt Plugin Already Installed && !force
  Orchestrator --> CLI: ERROR: Already installed
  CLI --> User: Error message\n(use --force to reinstall)
else Plugin Not Installed or Force

  Orchestrator -> Compat: checkCompatibility(request)
  note right: **CRIT-002b:**\nVersion compatibility\nOS/arch validation
  Compat --> Orchestrator: compatibilityVerdict

  alt Compatibility Failed
    Orchestrator --> CLI: ERROR: Incompatible
    CLI --> User: Compatibility errors
  else Compatible

    note over Orchestrator: **Step 2: STAGE**\nCreate temp workspace
    Orchestrator -> Cache: stageArtifacts(pluginId, version)
    Cache -> CacheDB: mkdir(.claude-plugin/tmp/<txId>)
    Cache --> Orchestrator: stagingPath, transactionId

    note over Orchestrator: **Step 3: DOWNLOAD & EXTRACT**\nFetch artifacts, validate manifest
    Orchestrator -> Orchestrator: downloadArtifacts(stagingPath)
    note right: TODO: Marketplace fetch logic
    Orchestrator -> Validator: validateManifest(manifestPath)
    note right: **Schema validation**\nJSON Schema Draft-07
    Validator --> Orchestrator: validationResult

    alt Validation Failed
      Orchestrator -> Cache: cleanup(stagingPath)
      Orchestrator --> CLI: ERROR: Invalid manifest
      CLI --> User: Validation errors
    else Valid Manifest

      note over Orchestrator: **Step 4: LIFECYCLE PRE-INSTALL**\nDisplay scripts, obtain consent
      Orchestrator -> Lifecycle: displayScripts(manifest.lifecycle)
      note right: **CRIT-004:**\nLifecycle script consent
      Lifecycle -> User: Show pre-install script
      User -> Lifecycle: Grant/deny consent
      Lifecycle --> Orchestrator: consentGranted, scriptDigest

      alt Consent Denied
        Orchestrator -> Cache: cleanup(stagingPath)
        Orchestrator --> CLI: ABORTED: User declined
        CLI --> User: Installation aborted
      else Consent Granted

        Orchestrator -> Lifecycle: execute(preInstall, sandbox)
        note right: **Sandboxed execution**\nTimeout: 5 minutes
        Lifecycle --> Orchestrator: executionResult

        alt Lifecycle Script Failed
          Orchestrator -> Orchestrator: Trigger rollbackPlan
          Orchestrator -> Cache: cleanup(stagingPath)
          Orchestrator --> CLI: ERROR: Pre-install failed
          CLI --> User: Lifecycle error details
        else Pre-Install Success

          note over Orchestrator: **Step 5: PROMOTE**\nAtomic cache promotion
          Orchestrator -> Cache: promoteArtifacts(pluginId, version, stagingPath)
          note right: **CRIT-018: Atomic operations**\nfs.rename (atomic on same FS)
          Cache -> CacheDB: mv staging → cache/<pluginId>/<version>
          Cache -> Cache: calculateChecksum(cachePath)
          Cache -> Cache: updateCacheIndex()
          Cache -> Cache: enforceRetention(pluginId)
          note right: **CRIT-002:**\nLast 3 versions per plugin\n500 MB global limit
          Cache -> Cache: evictCache() [if needed]
          Cache --> Orchestrator: cachePath, checksum, evicted

          note over Orchestrator: **Step 6: ACTIVATE**\nUpdate registry atomically
          Orchestrator -> Registry: addPlugin(plugin, options)
          note right: **CRIT-001:**\nTransaction ID tracking\nTelemetry snapshot
          Registry -> RegistryDB: Write temp registry.json.tmp
          Registry -> RegistryDB: fs.rename registry.json.tmp → registry.json
          note right: **Atomic registry update**
          Registry --> Orchestrator: registryResult

          alt Registry Update Failed
            Orchestrator -> Cache: removeDirectory(cachePath)
            note right: **Rollback on failure**
            Orchestrator --> CLI: ERROR: Registry update failed
            CLI --> User: Error + rollback details
          else Registry Updated

            Orchestrator -> Symlink: activate(pluginId, cachePath)
            note right: **Idempotent activation**\nSymlink: <installDir>/<id> → cachePath
            Symlink --> Orchestrator: activationResult

            note over Orchestrator: **Step 7: POST-INSTALL & TELEMETRY**
            Orchestrator -> Lifecycle: execute(postInstall, sandbox)
            Lifecycle --> Orchestrator: postInstallResult

            Orchestrator -> Telemetry: recordInstall(transactionId, metadata)
            note right: **CRIT-010:**\nStructured JSON logs\nPrometheus metrics\nOpenTelemetry traces
            Telemetry --> Orchestrator: telemetrySnapshot

            note over Orchestrator: **Step 8: CLEANUP**\nRemove staging dirs
            Orchestrator -> Cache: cleanupOrphanedTemp()
            Cache --> Orchestrator: cleaned count

            Orchestrator --> CLI: InstallResult (success)
            CLI --> User: ✓ Installed <id>@<version>\nTransaction: <txId>
          end
        end
      end
    end
  end
end

== Rollback Transaction Flow (FR-003) ==

User -> CLI: plugin rollback <id> [--version <ver>]
note right: **FR-003: Rollback Plugin**\nCRIT-002: Rollback from cache

CLI -> CLI: Check enableRollback flag
note right: **Feature flag gating**\nflags.json: enableRollback

alt Feature Disabled
  CLI --> User: ERROR: Rollback not enabled
else Feature Enabled
  CLI -> Orchestrator: rollback(request)

  Orchestrator -> Registry: getPlugin(pluginId)
  Registry --> Orchestrator: currentPlugin

  alt Plugin Not Installed
    Orchestrator --> CLI: ERROR: Not installed
    CLI --> User: Error message
  else Plugin Installed

    Orchestrator -> Cache: listEntries(pluginId)
    Cache --> Orchestrator: cachedVersions[]

    alt No Cached Versions
      Orchestrator --> CLI: ERROR: No rollback target
      CLI --> User: No cached versions available
    else Has Cached Version

      Orchestrator -> Orchestrator: Determine targetVersion\n(previous or specified)

      Orchestrator -> Cache: retrieveArtifacts(pluginId, targetVersion)
      Cache -> CacheDB: Verify cache path exists
      Cache -> Cache: Update lastAccessTime (LRU)
      Cache --> Orchestrator: cachePath

      alt Cache Miss
        Orchestrator --> CLI: ERROR: Cache missing
        CLI --> User: Version not in cache\n(re-download required)
      else Cache Hit

        Orchestrator -> Lifecycle: execute(uninstall, currentVersion)
        note right: **Pre-rollback cleanup**
        Lifecycle --> Orchestrator: uninstallResult

        Orchestrator -> Registry: updatePlugin(pluginId, updates)
        note right: **Atomic registry update**\nPoint to rollback version
        Registry -> RegistryDB: Write + rename atomically
        Registry --> Orchestrator: updateResult

        Orchestrator -> Symlink: activate(pluginId, cachePath)
        note right: **Swap symlink target**
        Symlink --> Orchestrator: activationResult

        Orchestrator -> Telemetry: recordRollback(transactionId, metadata)
        Telemetry --> Orchestrator: telemetrySnapshot

        Orchestrator --> CLI: InstallResult (rollback success)
        CLI --> User: ✓ Rolled back to <version>\nTransaction: <txId>
      end
    end
  end
end

== Update Transaction Flow (FR-002) ==

User -> CLI: plugin update <id> [--version <ver>]
note right: **FR-002: Update Plugin**

CLI -> Orchestrator: update(request)

Orchestrator -> Registry: getPlugin(pluginId)
Registry --> Orchestrator: currentPlugin

alt Plugin Not Installed
  Orchestrator --> CLI: ERROR: Not installed
  CLI --> User: Error message
else Plugin Installed

  Orchestrator -> Orchestrator: Resolve target version\n(latest or specified)

  alt Current == Target
    Orchestrator --> CLI: Already up-to-date
    CLI --> User: No update needed
  else Update Available

    note over Orchestrator: **Update = Install(force=true)**\nReuses install lifecycle
    Orchestrator -> Orchestrator: install(request, force=true)
    note right: Follows same 7-step\ntransaction lifecycle

    Orchestrator --> CLI: InstallResult (update success)
    CLI --> User: ✓ Updated <id>\n<oldVer> → <newVer>\nTransaction: <txId>
  end
end

== Error Handling & Rollback ==

note over Orchestrator: **Rollback on Failure**\nAny step failure triggers cleanup

alt Failure During Transaction
  Orchestrator -> Orchestrator: Execute rollbackPlan[]
  loop Each RollbackStep
    Orchestrator -> Orchestrator: Revert | Cleanup | Restore
  end

  Orchestrator -> Cache: cleanup(stagingPath)
  Orchestrator -> Registry: restoreFromBackup() [if backup created]
  note right: **Registry backup restoration**\nBackups created before mutations

  Orchestrator -> Telemetry: recordFailure(transactionId, error)
  note right: **CRIT-010:**\nCapture failure telemetry\nwith correlation ID

  Orchestrator --> CLI: InstallResult (error, rollback complete)
  CLI --> User: ✗ Installation failed\nRollback complete\nTransaction: <txId>
end

@enduml
