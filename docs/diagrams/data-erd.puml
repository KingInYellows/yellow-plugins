@startuml data-erd
' Entity Relationship Diagram (ERD)
' Claude Code Plugin Marketplace - Data Model
'
' This diagram shows the core data entities and their relationships
' as defined in Section 5.0 "The Contract" and Section 3.0 "Data Models"
'
' Generated for: I1.T3 - Validation toolkit and baseline diagrams
' Date: 2026-01-11
' Spec Reference: Section 5.0 "The Contract", SPECIFICATION-PART1-v1.1.md

!define ENTITY_COLOR #E3F2FD
!define PRIMARY_KEY_COLOR #1976D2
!define FOREIGN_KEY_COLOR #7B1FA2

skinparam class {
    BackgroundColor ENTITY_COLOR
    BorderColor #1976D2
    ArrowColor #1976D2
    FontSize 12
}

skinparam classAttribute {
    FontSize 11
}

' Core Entities

entity "MarketplaceIndex" as marketplace {
    **Primary Entity: Discovery & Updates**
    --
    * version : String <<PK>>
    * generatedAt : DateTime
    * generatorVersion : String
    * checksumAlgorithm : String
    * signature : String (optional)
    --
    **Metadata**
    name : String
    author : String
    description : String (optional)
    url : URI (optional)
    updatedAt : DateTime
}

entity "PluginEntry" as plugin_entry {
    **Plugin Reference in Marketplace**
    --
    * id : String <<PK>>
    * name : String
    * version : String (semver)
    * source : String (relative path)
    * category : Enum
    --
    **Optional Metadata**
    author : String
    description : String (max 280 chars)
    tags : String[]
    featured : Boolean
    verified : Boolean
    downloads : Integer
    updatedAt : DateTime
    --
    **Computed/Derived**
    manifestPath : String (derived)
    latestVersion : String (derived)
    checksum : String
    changelogUrl : URI
    deprecated : Boolean
    pinPriority : Integer
}

entity "PluginManifest" as plugin_manifest {
    **Complete Plugin Definition**
    --
    * name : String <<PK>>
    * version : String (semver)
    * description : String (10-280 chars)
    * author : JSON Object
    * entrypoints : JSON Object
    * compatibility : JSON Object
    * permissions : JSON Array
    --
    **Optional Fields**
    docs : JSON Object
    repository : JSON Object
    lifecycle : JSON Object
    dependencies : JSON Object
    keywords : String[]
    license : String (SPDX)
    homepage : URI
    --
    **Security**
    installNotes : String
    hashes : JSON Object
    signing : JSON Object (optional)
}

entity "InstalledPluginRegistry" as installed_registry {
    **Local Installation State**
    --
    * registryVersion : String
    * lastUpdated : DateTime
    --
    **Collections**
    installed[] : InstalledPlugin
    activePins[] : String[]
    telemetry : JSON Object
}

entity "InstalledPlugin" as installed_plugin {
    **Installed Plugin Record**
    --
    * pluginId : String <<FK>>
    * version : String (semver)
    * source : String
    * installState : Enum
    * installedAt : DateTime
    --
    **Cache & Links**
    cachePath : String
    symlinkTarget : String
    lastValidatedAt : DateTime
    --
    **Transaction**
    transactionId : String
}

entity "LifecycleScriptRecord" as lifecycle_record {
    **Lifecycle Script Consent & Tracking**
    --
    * pluginId : String <<FK>>
    * version : String (semver)
    * scriptType : Enum
    * digest : String (SHA-256)
    * lastConsentAt : DateTime
    --
    **Execution Tracking**
    executionDuration : Integer (ms)
    exitCode : Integer
    lastExecutedAt : DateTime
    --
    **Security**
    scriptContent : String (hashed)
    consentRequired : Boolean
}

entity "ChangelogMetadata" as changelog_metadata {
    **Changelog Retrieval & Caching**
    --
    * pluginId : String <<FK>>
    * version : String (semver)
    * url : URI
    --
    **Retrieval Status**
    retrievedAt : DateTime
    status : Enum (success/failure)
    failureReason : String (optional)
    --
    **Cache**
    cachedContent : String (optional)
    contentHash : String
}

entity "PermissionDeclaration" as permission {
    **Plugin Permission Request**
    --
    * scope : Enum
    * reason : String (10-200 chars)
    --
    **Scope-Specific Constraints**
    paths : String[] (for filesystem)
    domains : String[] (for network)
    commands : String[] (for shell)
    envVars : String[] (for env)
    --
    **Consent**
    consentGranted : Boolean
    consentedAt : DateTime
}

entity "Compatibility" as compatibility {
    **Compatibility Requirements**
    --
    * claudeCodeMin : String (semver)
    --
    **Optional Constraints**
    claudeCodeMax : String (semver)
    nodeMin : String (major version)
    os : String[] (enum)
    arch : String[] (enum)
    pluginDependencies : String[]
}

' Relationships

marketplace ||--o{ plugin_entry : "contains"
plugin_entry ||--|| plugin_manifest : "references via\nmanifestPath"
plugin_manifest ||--|{ permission : "declares"
plugin_manifest ||--|| compatibility : "specifies"

installed_registry ||--o{ installed_plugin : "tracks"
installed_plugin }o--|| plugin_entry : "installed from"
installed_plugin ||--o{ lifecycle_record : "executes"
installed_plugin ||--o{ changelog_metadata : "retrieves"

plugin_manifest ||--o{ lifecycle_record : "defines scripts"
plugin_entry ||--o| changelog_metadata : "provides url"

' Notes explaining key relationships

note right of marketplace
  **Single Source of Truth**
  - Version-controlled in Git
  - Contains all plugin references
  - Signature for integrity
  - Generated by publish command
end note

note right of plugin_manifest
  **Schema Validation**
  - Validated by AJV (Draft-07)
  - Mandatory fields enforced
  - Compatibility checked at install
  - Permissions require user consent
end note

note right of installed_registry
  **Atomic Transactions**
  - Registry mutations carry transactionId
  - Rollback support via Git
  - Telemetry for analytics
  - Active pins for priority plugins
end note

note right of lifecycle_record
  **Security & Consent**
  - Scripts digested (SHA-256)
  - Consent required for changes
  - Execution tracked for audit
  - Timeout: 5 minutes max
end note

note bottom of compatibility
  **Validation at Install Time**
  - Claude Code version checked
  - Node.js version verified
  - Platform/arch compatibility
  - Plugin dependencies resolved

  **References**
  - CRIT-002b: Version checking
  - CRIT-005: Platform validation
end note

' Legend

legend right
  **Entity Types**
  * Required field
  Optional field

  **Key Types**
  <<PK>> = Primary Key
  <<FK>> = Foreign Key

  **Data Sources**
  - marketplace.json (Git-tracked)
  - plugin.json (per plugin)
  - installed.json (local state)

  **Validation**
  All entities validated against
  JSON Schema Draft-07 specs

  **Spec References**
  - Section 5.0: "The Contract"
  - Section 3.0: Data Models
  - Appendix B: JSON Schemas
endlegend

@enduml
